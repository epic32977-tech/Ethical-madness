#!/bin/bash
set -e

# --- Configuration ---
BACKUP_PATH=$1  # Pass the directory path as the first argument
RESTORE_ROOT="$HOME/restored_projects"

if [ -z "$BACKUP_PATH" ]; then
    echo "âŒ Usage: ./restore.sh /path/to/backup_folder"
    exit 1
fi

echo "ğŸ”¥ Initiating 'Phoenix' Restore Protocol..."

# 1. Environment Check
termux-setup-storage
mkdir -p "$RESTORE_ROOT"

# 2. Decryption
echo "ğŸ” Decrypting archive..."
gpg --batch --decrypt --passphrase-fd 0 "$BACKUP_PATH/data_archive.tar.gz.gpg" > "$BACKUP_PATH/decrypted_data.tar.gz"

# 3. Extraction
echo "ğŸ—œï¸ Extracting files to $RESTORE_ROOT..."
tar -xzpf "$BACKUP_PATH/decrypted_data.tar.gz" -C "$RESTORE_ROOT"

# 4. Rebuilding Git Repos from Bundles
echo "ğŸŒ¿ Reconstituting Git repositories..."
find "$BACKUP_PATH" -name "*.gitbundle" -print0 | while IFS= read -r -d '' bundle; do
    repo_name=$(basename "$bundle" .gitbundle)
    echo "  - Cloning from $repo_name.gitbundle"
    git clone "$bundle" "$RESTORE_ROOT/$repo_name"
done

# 5. Database Verification
echo "ğŸ“Š Database Integrity Report:"
find "$BACKUP_PATH" -name "*_integrity.txt" -exec echo "--- {} ---" \; -exec cat {} \;

echo "âœ… Restore complete. Files located in: $RESTORE_ROOT"
